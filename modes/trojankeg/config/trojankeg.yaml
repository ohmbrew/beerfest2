#config_version=5
##! mode: trojankeg

# Trojan Keg
# Player must:
# 1. Lock Popo
# 2. Hit all pops
# 3. Hit Keg Saucer

mode:
  start_events: start_mode_trojankeg
  stop_events: stop_mode_trojankeg, stop_missions, slide_event_done   # untimed round
  events_when_started: mode_type_mission_started
  events_when_stopped: mode_type_mission_stopped
  priority: 300

accruals:
  trojankeg_pops_accrual:
    persist_state: false
    events:
      - shot_pop_upper_right_hit
      - shot_pop_upper_left_hit
      - shot_pop_lower_hit
    events_when_complete: trojankeg_pops_complete
    restart_events: shot_popo_captured_hit
    reset_on_complete: true
    disable_on_complete: false

# config trojankeg successful completion state machine
state_machines:
  trojankeg_state_machine:
    persist_state: False
    states:
      start:
        label: Trojan Keg SM Starting
      wait_for_popo_captured:
        label: waiting to lock popo
        show_when_active:
          show: flash_trojankeg_wait_popo
          speed: 4
          loops: -1
          priority: 1000
      wait_for_pops:
        label: Waiting for pops accrual
        show_when_active:
          show: flash_trojankeg_wait_pops
          speed: 4
          loops: -1
          priority: 1000
        events_when_started: show_mini_pops, play_objective_audio_with_hitpops_after
      wait_for_keg:
        label: Waiting for keg hit
        events_when_started: show_mini_keg, play_objective_audio_with_shoot_keg_after
        show_when_active:
          show: flash_trojankeg_wait_keg
          speed: 4
          loops: -1
          priority: 1000
      trojankeg_completed:
        label: Trojan Keg Completed
        events_when_started: trojankeg_success
      trojankeg_inactive:
        label: Trojan Keg Inactive

    transitions:
      - source: start
        target: wait_for_popo_captured
        events: mode_trojankeg_started
      - source: wait_for_popo_captured
        target: wait_for_pops
        events: shot_popo_captured_hit
      - source: wait_for_pops
        target: wait_for_keg
        events: trojankeg_pops_complete
      - source: wait_for_keg
        target: trojankeg_completed
        events: shot_kicker_mode_hit
      # putting these in here to prevent player from getting bonus again if we see event_success, _fail, or _partial  
      - source: wait_for_popo_captured
        target: trojankeg_inactive
        events: trojankeg_success, trojankeg_fail, trojankeg_partial
      - source: wait_for_pops
        target: trojankeg_inactive
        events: trojankeg_success, trojankeg_fail, trojankeg_partial
      - source: wait_for_keg
        target: trojankeg_inactive
        events: trojankeg_success, trojankeg_fail, trojankeg_partial

sound_player:
  mode_trojankeg_started:
    voice_trojankeg_intro:
      action: play
      loops: 0
      events_when_stopped: saucer_release, intro_done

  # Field, and any of the Game Modes (Quarters, Strike Out, etc.) must implement their own listeners on shot_kicker_mode_hit or shot_kicker_rimrules_hit.
  shot_kicker_mode_hit{device.state_machines.trojankeg_state_machine.state != "wait_for_keg" and device.state_machines.trojankeg_state_machine.state != "trojankeg_completed"}:
    voice_betterwhendrunk:
      action: play
      events_when_stopped: kicker_mode_eject
  shot_kicker_rimrules_hit:
    rimrules:
      action: play
      events_when_stopped: kicker_rimrules_eject
  trojankeg_success:
    themedrinkonme:
      action: stop
    themehardasarock:
      action: stop
    themejungleboogie:
      action: stop
    themealcohol:
      action: stop
    themebeer:
      action: stop
    themebeerformyhorses:
      action: stop
    themebyob:
      action: stop
    themecomininhot:
      action: stop
    sureasschnitzel:
      action: play
  trojankeg_fail:
    themedrinkonme:
      action: stop
    themehardasarock:
      action: stop
    themejungleboogie:
      action: stop
    themealcohol:
      action: stop
    themebeer:
      action: stop
    themebeerformyhorses:
      action: stop
    themebyob:
      action: stop
    themecomininhot:
      action: stop
    goddamnbrewery:
      action: play
      events_when_stopped: slide_event_result_complete
  trojankeg_partial:
    prettyclose:
      action: play
      events_when_stopped: slide_event_result_complete
  
  award_trojankeg_bonus:
    voice_trojankeg_megabonus:
      action: play
      events_when_stopped: trojankeg_bonus_audio_complete

   # shots we want BEERFEST! and All Blue light show to play
  play_objective_audio:
    voice_beerfest:
      action: play

  play_objective_audio_with_shoot_keg_after:
    voice_beerfest:
      action: play
      events_when_stopped: play_hitthekeg

  play_hitthekeg:
    voice_hitthekeg:
      action: play

  play_objective_audio_with_hitpops_after:
    voice_beerfest:
      action: play
      events_when_stopped: play_hitpops

  play_hitpops:
    voice_hitpops:
      action: play   

slides:
  slide_trojankeg_intro:
    widgets:
      - type: image
        image: MainText-BeerfestEvent
      - type: image
        image: MainText-TrojanKegIntro
        scale: .1
        animations:
          show_slide:
            - property: scale
              value: 1
              duration: 1s
      - type: video
        video: bubbles
        end_behavior: loop
  slide_trojankeg_main:
    widgets:
      - type: image
        image: background-flag
      - type: image
        image: MainText-TrojanKegTitle
      - type: text
        text: (score)
        number_grouping: true
        min_digits: 1
        font_name: druillet
        color: 008ce5ff
        font_size: 125
        anchor_x: middle
        anchor_y: middle
        x: middle
        y: middle
      - type: text
        text: Ball (ball)
        font_name: druillet
        color: 008ce5ff
        font_size: 65
        anchor_x: middle
        anchor_y: bottom
        x: middle
        y: bottom + 35
      - type: video
        video: bubbles
        end_behavior: loop
  slide_trojankeg_success:
    widgets:
      - type: image
        image: background-flag
      - type: image
        image: MainText-TrojanKegTitle
      - type: text
        text: SUCCESS
        font_name: druillet
        color: green
        font_size: 10
        anchor_x: middle
        anchor_y: middle
        x: middle
        y: middle - 50
        animations:
          show_slide:
            - property: font_size
              value: 200
              duration: .5s
      - type: text
        text: (player|pts_volumechug_success)
        number_grouping: true
        min_digits: 1
        font_name: druillet
        color: 008ce5ff
        font_size: 10
        anchor_x: middle
        anchor_y: bottom
        x: middle
        y: bottom + 25
        animations:
          show_slide:
            - property: font_size
              value: 150
              duration: .5s
      - type: video
        video: bubbles
        end_behavior: loop
  slide_trojankeg_fail:
    widgets:
      - type: image
        image: background-flag
      - type: image
        image: MainText-TrojanKegTitle
      - type: text
        text: FAIL
        font_name: druillet
        color: red
        font_size: 10
        anchor_x: middle
        anchor_y: middle
        x: middle
        y: middle - 50
        animations:
          show_slide:
            - property: font_size
              value: 200
              duration: 1s
      - type: video
        video: bubbles
        end_behavior: loop
  slide_trojankeg_partial:        # if they hit quarters, but drained before round timer expires
    widgets:
      - type: image
        image: background-flag
      - type: image
        image: MainText-TrojanKegTitle
        anchor_x: middle
        anchor_y: middle
        x: middle
        y: middle
      - type: text
        text: SUCCESS
        font_name: druillet
        color: green
        font_size: 10
        anchor_x: middle
        anchor_y: middle
        x: middle
        y: top - 250
        animations:
          show_slide:
            - property: font_size
              value: 100
              duration: .5s
      - type: text
        text: (player|pts_trojankeg_partial)
        number_grouping: true
        min_digits: 1
        font_name: druillet
        color: 008ce5ff
        font_size: 10
        anchor_x: middle
        anchor_y: middle
        x: middle
        y: top - 450
        animations:
          show_slide:
            - property: font_size
              value: 225
              duration: .5s
      - type: video
        video: bubbles
        end_behavior: loop
  slide_bonus_trojankeg_themed:
    widgets:
    - type: image
      image: background-flag
    - type: image
      image: MainText-TrojanKegTitle
    - type: text
      text: SUCCESS
      font_name: druillet
      color: green
      font_size: 10
      anchor_x: middle
      anchor_y: middle
      x: middle
      y: middle - 50
      animations:
        show_slide:
          - property: font_size
            value: 200
            duration: .5s
    - type: text
      text: (player|pts_trojankeg_partial)
      number_grouping: true
      min_digits: 1
      font_name: druillet
      color: 008ce5ff
      font_size: 10
      anchor_x: middle
      anchor_y: bottom
      x: middle
      y: bottom + 25
      animations:
        show_slide:
          - property: font_size
            value: 150
            duration: .5s
    - type: video
      video: bubbles
      end_behavior: loop
  mini_popo:
    widgets:
    - type: image
      image: MiniText-LockPopo
      animations:
        show_slide:
          - property: opacity
            value: 1
            duration: 0.5s
            easing: in_out_quint
          - property: opacity
            value: 0
            duration: 0.5s
            repeat: true
            easing: in_out_quint
    - type: image
      image: beermug7
  mini_pops:
    widgets:
    - type: image
      image: MiniText-ShootPops
      animations:
        show_slide:
          - property: opacity
            value: 1
            duration: 0.5s
            easing: in_out_quint
          - property: opacity
            value: 0
            duration: 0.5s
            repeat: true
            easing: in_out_quint
    - type: image
      image: beermug7
  mini_keg:
    widgets:
    - type: image
      image: MiniText-ShootKeg
      animations:
        show_slide:
          - property: opacity
            value: 1
            duration: 0.5s
            easing: in_out_quint
          - property: opacity
            value: 0
            duration: 0.5s
            repeat: true
            easing: in_out_quint
    - type: image
      image: beermug7

slide_player:
  mode_trojankeg_started:
    slide_trojankeg_intro:
      target: main
      expire: 5s
    mini_popo:
      target: mini
  slide_slide_trojankeg_intro_removed:
    slide_trojankeg_intro:
      target: main
      action: remove
    slide_trojankeg_main:
      target: main
      action: play
  award_trojankeg_bonus:
    slide_bonus_trojankeg_themed:
      target: main
      action: play
      priority: 1000
  trojankeg_bonus_audio_complete:
    slide_bonus_trojankeg_themed:
      target: main
      action: remove
  show_mini_pops:
    mini_popo:
      target: mini
      action: remove
    mini_pops:
      target: mini
      action: play
  show_mini_keg:
    mini_pops:
      target: mini
      action: remove
    mini_keg:
      target: mini
      action: play
  trojankeg_success:
    slide_trojankeg_main:
      target: main
      action: remove
    slide_trojankeg_success:
      target: main
      action: play
      expire: 3s
  trojankeg_fail:
    slide_trojankeg_main:
      target: main
      action: remove
    slide_trojankeg_fail:
      target: main
      action: play
      expire: 3s
  trojankeg_partial:
    slide_trojankeg_main:
      target: main
      action: remove

    slide_trojankeg_partial:
      target: main
      action: play
  slide_trojankeg_success_removed:
    slide_trojankeg_success:
      target: main
      action: remove
    slide_trojankeg_fail:
      target: main
      action: remove
    slide_trojankeg_partial:
      target: main
      action: remove  

queue_relay_player:
  # mode_trojankeg_stopping{device.timers.round_timer_trojankeg.ticks == 0 and current_player.has_current_thememode==1}:  # timer expired, player completed bonus
  #   post: trojankeg_success
  #   wait_for: slide_slide_trojankeg_success_removed
  mode_trojankeg_stopping{current_player.has_current_thememode==0}:  # ball drained, player did not complete objectives
    post: trojankeg_fail
    wait_for: slide_slide_trojankeg_fail_removed
  # mode_trojankeg_stopping{device.timers.round_timer_trojankeg.ticks > 0 and current_player.has_current_thememode==1}:   # timer did not expire (we drained?), but player completed bonus
  #   post: trojankeg_partial
  #   wait_for: slide_slide_trojankeg_partial_removed
  # mode_trojankeg_stopping{device.timers.round_timer_trojankeg.ticks > 0 and current_player.has_current_thememode==0}:   # timer did not expire (we drained?), and player did not complete bonus
  #   post: trojankeg_fail
  #   wait_for: slide_slide_trojankegfail_removed  
  ball_ending:  # delay ball_ending until whicher slide is shown above finishes
    post: nothing
    wait_for: slide_event_done

event_player:
  slide_slide_trojankeg_intro_removed: choose_random_background_music
  slide_slide_trojankeg_success_removed: slide_event_done
  slide_slide_trojankeg_fail_removed: slide_event_done
  slide_slide_trojankeg_partial_removed: slide_event_done
  slide_slide_bonus_trojankeg_themed_removed: kicker_mode_eject
  saucer_release{device.switches.s_kicker_rimrules.state == 1}: kicker_rimrules_eject
  saucer_release{device.switches.s_kicker_mode.state == 1}: kicker_mode_eject
  slide_slide_trojankeg_intro_removed{device.switches.s_popo_captured.state == 1}: eject_popo

shows:
  flash_trojankeg_insert:
    - duration: 1
      lights:
        mode_trojankeg: yellow
    - duration: 1
      lights:
        mode_trojankeg: off

  flash_trojankeg_wait_popo:
    - duration: 1
      lights:
        arrow_popo1: green
        arrow_popo2: off
        arrow_popo3: off
    - duration: 1
      lights:
        arrow_popo1: green
        arrow_popo2: green
        arrow_popo3: off
    - duration: 1
      lights:
        arrow_popo1: green
        arrow_popo2: green
        arrow_popo3: green
    - duration: 1
      lights:
        arrow_popo1: off
    - duration: 1
      lights:
        arrow_popo2: off
    - duration: 1
      lights:
        arrow_popo3: off
  
  flash_trojankeg_wait_pops:
    - duration: 1
      lights:
        l_pop_lower: on
        l_pop_right: on
        l_pop_left: on
    - duration: 1
      lights:
        l_pop_lower: off
        l_pop_right: off
        l_pop_left: off
  
  flash_trojankeg_wait_keg:
    - duration: 1
      lights:
        arrow_mode1: green
        arrow_mode2: off
        arrow_mode3: off
    - duration: 1
      lights:
        arrow_mode1: green
        arrow_mode2: green
        arrow_mode3: off
    - duration: 1
      lights:
        arrow_mode1: green
        arrow_mode2: green
        arrow_mode3: green
    - duration: 1
      lights:
        arrow_mode1: off
    - duration: 1
      lights:
        arrow_mode2: off
    - duration: 1
      lights:
        arrow_mode3: off
  
  flash_all_blue_trojankeg:
    - duration: .5s
      lights:
        playfield:
          color: 008ce5
          fade: .1s
        gi:
          color: 008ce5
          fade: .1s
    - duration: .5s
      lights:
        playfield:
          color: off
          fade: .5s
        gi:
          color: off
          fade: .5s

show_player:
  mode_trojankeg_started:
    init_lights_themed:
      loops: 0
  mode_trojankeg_started.1:
    flash_trojankeg_insert:
      speed: 2
  choose_random_background_music:
    flash_gi_themed:
      speed: 4
      loops: -1
  
  # stop light shows on success/partial/fail
  trojankeg_success:
    flash_trojankeg_wait_popo:
      action: stop
    flash_trojankeg_wait_pops:
      action: stop
    flash_trojankeg_wait_keg:
      action: stop  
    flash_gi_themed:
      action: stop
    flash_trojankeg_insert:
      action: stop

  trojankeg_partial:
    flash_trojankeg_wait_popo:
      action: stop
    flash_trojankeg_wait_pops:
      action: stop
    flash_trojankeg_wait_keg:
      action: stop  
    flash_gi_themed:
      action: stop
    flash_trojankeg_insert:
      action: stop
  trojankeg_fail:
    flash_trojankeg_wait_popo:
      action: stop
    flash_trojankeg_wait_pops:
      action: stop
    flash_trojankeg_wait_keg:
      action: stop  
    flash_gi_themed:
      action: stop
    flash_trojankeg_insert:
      action: stop

  # hits that we want to flash everything blue:
  play_objective_audio:
    flash_all_blue_trojankeg:
      priority: 5000
      loops: 0
      action: play

  play_objective_audio_with_shoot_keg_after:
    flash_all_blue_trojankeg:
      priority: 5000
      loops: 0
      action: play

variable_player:
  mode_trojankeg_started:    # init whether we completed this current bonus
    has_current_thememode:
      int: 0
      action: set

  shot_kicker_mode_hit:
    score: current_player.pts_kicker_mode_themed
    
  trojankeg_success:
    score: current_player.pts_trojankeg_success
    has_trojankeg:
      action: set
      int: 1
    has_current_thememode:
      int: 1
      action: set
  trojankeg_partial:
    score: current_player.pts_trojankeg_partial
    has_trojankeg:
      action: set
      int: 1